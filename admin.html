<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>romiSIM Admin Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    }
    .logo-text {
      font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
      font-size: 24px;
      font-weight: 700;
      letter-spacing: -0.5px;
    }
  </style>
</head>
<body class="bg-black text-white">
  <div id="app"></div>

  <script type="module">
    import React from 'https://esm.sh/react@18.2.0';
    import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
    import { LogOut, Eye, Search, Download, TrendingUp, Users, ShoppingCart, DollarSign } from 'https://esm.sh/lucide-react@0.263.1';

    const { useState, useEffect } = React;

    function AdminDashboard() {
      const [adminKey, setAdminKey] = useState('');
      const [isAuthenticated, setIsAuthenticated] = useState(false);
      const [orders, setOrders] = useState([]);
      const [loading, setLoading] = useState(false);
      const [stats, setStats] = useState(null);
      const [searchTerm, setSearchTerm] = useState('');
      const [adminPassword, setAdminPassword] = useState('');
      const [loginError, setLoginError] = useState('');
      const [activeTab, setActiveTab] = useState('orders');
      const [rates, setRates] = useState([]);
      const [editingCountry, setEditingCountry] = useState(null);
      const [editingRate, setEditingRate] = useState('');
      const [ratesLoading, setRatesLoading] = useState(false);
      const [ratesError, setRatesError] = useState('');

      const BACKEND_BASE = window.location.origin;
      const ADMIN_PASSWORD = 'c1f16784b3a6b39acc534e51e0df3117';

      useEffect(() => {
        const stored = localStorage.getItem('adminAuth');
        if (stored) {
          setIsAuthenticated(true);
          loadData();
          loadRates();
        }
      }, []);

      function handleLogin() {
        if (adminPassword === ADMIN_PASSWORD) {
          localStorage.setItem('adminAuth', 'true');
          setIsAuthenticated(true);
          setLoginError('');
          setAdminPassword('');
          loadData();
        } else {
          setLoginError('Invalid password');
        }
      }

      function handleLogout() {
        localStorage.removeItem('adminAuth');
        setIsAuthenticated(false);
        setOrders([]);
        setStats(null);
      }

      async function loadData() {
        setLoading(true);
        try {
          const res = await fetch(`${BACKEND_BASE}/api/admin/orders`, {
            headers: {
              'Authorization': `Bearer admin`,
            },
          });
          if (!res.ok) throw new Error('Failed to load orders');
          const data = await res.json();
          setOrders(data.orders || []);
          setStats(data.stats || null);
        } catch (err) {
          console.error(err);
        } finally {
          setLoading(false);
        }
      }

      async function loadRates() {
        setRatesLoading(true);
        setRatesError('');
        try {
          const res = await fetch(`${BACKEND_BASE}/api/admin/rates`, {
            headers: {
              'Authorization': `Bearer admin`,
            },
          });
          if (!res.ok) throw new Error('Failed to load rates');
          const data = await res.json();
          setRates(data.rates || []);
        } catch (err) {
          console.error(err);
          setRatesError('Failed to load currency rates');
        } finally {
          setRatesLoading(false);
        }
      }

      async function updateRate() {
        if (!editingCountry || !editingRate) {
          setRatesError('Please enter a valid rate');
          return;
        }

        const numRate = parseFloat(editingRate);
        if (isNaN(numRate) || numRate <= 0) {
          setRatesError('Rate must be a positive number');
          return;
        }

        try {
          const res = await fetch(`${BACKEND_BASE}/api/admin/rates/update`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer admin`,
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ country: editingCountry, rate: numRate }),
          });
          if (!res.ok) throw new Error('Failed to update rate');
          setRatesError('');
          setEditingCountry(null);
          setEditingRate('');
          await loadRates();
        } catch (err) {
          console.error(err);
          setRatesError('Failed to update rate: ' + err.message);
        }
      }

      const filteredOrders = orders.filter(order =>
        order.email.includes(searchTerm) ||
        order.phone.includes(searchTerm) ||
        order.id.includes(searchTerm)
      );

      if (!isAuthenticated) {
        return React.createElement('div', { className: 'min-h-screen bg-black text-white flex items-center justify-center px-4' },
          React.createElement('div', { className: 'w-full max-w-md' },
            React.createElement('div', { className: 'border border-white/10 rounded-2xl p-8 bg-gradient-to-br from-white/5 to-white/2' },
              React.createElement('h1', { className: 'logo-text text-center mb-2' }, 'romiSIM'),
              React.createElement('h2', { className: 'text-2xl font-bold text-center mb-8' }, 'Admin Login'),
              React.createElement('div', { className: 'space-y-4' },
                React.createElement('div', null,
                  React.createElement('label', { className: 'block text-sm font-medium mb-2' }, 'Password'),
                  React.createElement('input', {
                    type: 'password',
                    value: adminPassword,
                    onChange: (e) => setAdminPassword(e.target.value),
                    onKeyPress: (e) => e.key === 'Enter' && handleLogin(),
                    placeholder: 'Enter admin password',
                    className: 'w-full p-3 bg-white/5 border border-white/10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-white/30'
                  })
                ),
                loginError && React.createElement('div', { className: 'p-3 bg-red-500/10 border border-red-500/20 rounded text-red-400 text-sm' }, loginError),
                React.createElement('button', {
                  onClick: handleLogin,
                  className: 'w-full bg-white text-black px-4 py-3 rounded-lg font-medium hover:bg-gray-100 transition-colors'
                }, 'Login'),
                React.createElement('div', { className: 'text-center pt-4 border-t border-white/10' },
                  React.createElement('p', { className: 'text-xs text-gray-400 mb-2' }, 'Access this panel with Ctrl+Shift+A'),
                  React.createElement('a', { href: '/', className: 'text-sm text-blue-400 hover:text-blue-300' }, 'â† Back to Store')
                )
              )
            )
          )
        );
      }

      return React.createElement('div', { className: 'min-h-screen bg-black text-white' },
        React.createElement('header', { className: 'border-b border-white/5 bg-black/95 backdrop-blur sticky top-0 z-40' },
          React.createElement('div', { className: 'max-w-7xl mx-auto px-6 py-4 flex items-center justify-between' },
            React.createElement('h1', { className: 'logo-text' }, 'romiSIM Admin'),
            React.createElement('button', {
              onClick: handleLogout,
              className: 'flex items-center gap-2 px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg transition-colors'
            },
              React.createElement(LogOut, { className: 'w-4 h-4' }),
              React.createElement('span', null, 'Logout')
            )
          )
        ),

        React.createElement('main', { className: 'max-w-7xl mx-auto px-6 py-8' },
          React.createElement('div', { className: 'flex gap-4 mb-8 border-b border-white/10' },
            React.createElement('button', {
              onClick: () => setActiveTab('orders'),
              className: `px-6 py-3 font-medium transition-colors ${
                activeTab === 'orders' 
                  ? 'text-white border-b-2 border-white' 
                  : 'text-gray-400 hover:text-white'
              }`
            }, 'Orders'),
            React.createElement('button', {
              onClick: () => { setActiveTab('rates'); if (rates.length === 0) loadRates(); },
              className: `px-6 py-3 font-medium transition-colors ${
                activeTab === 'rates' 
                  ? 'text-white border-b-2 border-white' 
                  : 'text-gray-400 hover:text-white'
              }`
            }, 'Currency Rates')
          ),

          activeTab === 'orders' && (
            React.createElement(React.Fragment, null,
              stats && React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-4 gap-4 mb-8' },
            React.createElement('div', { className: 'bg-white/5 border border-white/10 rounded-xl p-6' },
              React.createElement('div', { className: 'flex items-center justify-between' },
                React.createElement('div', null,
                  React.createElement('p', { className: 'text-gray-400 text-sm' }, 'Total Revenue'),
                  React.createElement('p', { className: 'text-3xl font-bold mt-1' }, '$', stats.totalRevenue?.toFixed(2) || '0.00')
                ),
                React.createElement(DollarSign, { className: 'w-8 h-8 text-green-400 opacity-50' })
              )
            ),
            React.createElement('div', { className: 'bg-white/5 border border-white/10 rounded-xl p-6' },
              React.createElement('div', { className: 'flex items-center justify-between' },
                React.createElement('div', null,
                  React.createElement('p', { className: 'text-gray-400 text-sm' }, 'Total Orders'),
                  React.createElement('p', { className: 'text-3xl font-bold mt-1' }, stats.totalOrders || 0)
                ),
                React.createElement(ShoppingCart, { className: 'w-8 h-8 text-blue-400 opacity-50' })
              )
            ),
            React.createElement('div', { className: 'bg-white/5 border border-white/10 rounded-xl p-6' },
              React.createElement('div', { className: 'flex items-center justify-between' },
                React.createElement('div', null,
                  React.createElement('p', { className: 'text-gray-400 text-sm' }, 'Completed'),
                  React.createElement('p', { className: 'text-3xl font-bold mt-1' }, stats.completedOrders || 0)
                ),
                React.createElement(TrendingUp, { className: 'w-8 h-8 text-emerald-400 opacity-50' })
              )
            ),
            React.createElement('div', { className: 'bg-white/5 border border-white/10 rounded-xl p-6' },
              React.createElement('div', { className: 'flex items-center justify-between' },
                React.createElement('div', null,
                  React.createElement('p', { className: 'text-gray-400 text-sm' }, 'Customers'),
                  React.createElement('p', { className: 'text-3xl font-bold mt-1' }, stats.totalCustomers || 0)
                ),
                React.createElement(Users, { className: 'w-8 h-8 text-purple-400 opacity-50' })
              )
            )
          ),

          React.createElement('div', { className: 'mt-8' },
            React.createElement('div', { className: 'flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6' },
              React.createElement('h2', { className: 'text-2xl font-bold' }, 'Recent Orders'),
              React.createElement('div', { className: 'flex items-center gap-2' },
                React.createElement('div', { className: 'relative flex-1 md:flex-none' },
                  React.createElement(Search, { className: 'w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400' }),
                  React.createElement('input', {
                    type: 'text',
                    value: searchTerm,
                    onChange: (e) => setSearchTerm(e.target.value),
                    placeholder: 'Search by email, phone, or ID',
                    className: 'w-full pl-10 pr-4 py-2 bg-white/5 border border-white/10 rounded-lg text-sm text-white placeholder-gray-500 focus:outline-none focus:border-white/30'
                  })
                ),
                React.createElement('button', {
                  onClick: () => loadData(),
                  className: 'px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg transition-colors'
                }, 'Refresh')
              )
            ),

            loading ? React.createElement('div', { className: 'text-center py-12 text-gray-400' }, 'Loading orders...') :
            React.createElement('div', { className: 'border border-white/10 rounded-xl overflow-hidden' },
              React.createElement('div', { className: 'overflow-x-auto' },
                React.createElement('table', { className: 'w-full' },
                  React.createElement('thead', { className: 'bg-white/5 border-b border-white/10' },
                    React.createElement('tr', null,
                      React.createElement('th', { className: 'px-6 py-4 text-left text-sm font-semibold' }, 'Order ID'),
                      React.createElement('th', { className: 'px-6 py-4 text-left text-sm font-semibold' }, 'Customer'),
                      React.createElement('th', { className: 'px-6 py-4 text-left text-sm font-semibold' }, 'Phone'),
                      React.createElement('th', { className: 'px-6 py-4 text-left text-sm font-semibold' }, 'Plan'),
                      React.createElement('th', { className: 'px-6 py-4 text-left text-sm font-semibold' }, 'Amount'),
                      React.createElement('th', { className: 'px-6 py-4 text-left text-sm font-semibold' }, 'Status'),
                      React.createElement('th', { className: 'px-6 py-4 text-left text-sm font-semibold' }, 'Date')
                    )
                  ),
                  React.createElement('tbody', null,
                    filteredOrders.length === 0 ? 
                      React.createElement('tr', null,
                        React.createElement('td', { colSpan: 7, className: 'px-6 py-8 text-center text-gray-400' }, 'No orders found')
                      ) :
                      filteredOrders.map(order =>
                        React.createElement('tr', { key: order.id, className: 'border-t border-white/5 hover:bg-white/2 transition-colors' },
                          React.createElement('td', { className: 'px-6 py-4 text-sm font-mono text-gray-300' }, order.id.substring(0, 8) + '...'),
                          React.createElement('td', { className: 'px-6 py-4 text-sm' }, order.email),
                          React.createElement('td', { className: 'px-6 py-4 text-sm' }, order.phone),
                          React.createElement('td', { className: 'px-6 py-4 text-sm' }, order.plan_id),
                          React.createElement('td', { className: 'px-6 py-4 text-sm font-semibold' }, '$' + (order.amount || 'N/A')),
                          React.createElement('td', { className: 'px-6 py-4 text-sm' },
                            React.createElement('span', { className: `px-3 py-1 rounded-full text-xs font-medium ${
                              order.status === 'completed' ? 'bg-green-500/20 text-green-400' :
                              order.status === 'pending' ? 'bg-yellow-500/20 text-yellow-400' :
                              'bg-gray-500/20 text-gray-400'
                            }` }, order.status)
                          ),
                          React.createElement('td', { className: 'px-6 py-4 text-sm text-gray-400' },
                            new Date(order.created_at).toLocaleDateString()
                          )
                        )
                      )
                  )
                )
              )
            )
          )
          )
          ),

          activeTab === 'rates' && (
            React.createElement(React.Fragment, null,
              ratesError && React.createElement('div', { className: 'p-4 bg-red-500/10 border border-red-500/20 rounded-lg text-red-400 mb-6' }, ratesError),
              React.createElement('div', { className: 'flex justify-between items-center mb-6' },
                React.createElement('h2', { className: 'text-2xl font-bold' }, 'Exchange Rates'),
                React.createElement('button', {
                  onClick: () => loadRates(),
                  className: 'px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg transition-colors'
                }, 'Refresh')
              ),
              ratesLoading ? React.createElement('div', { className: 'text-center py-12 text-gray-400' }, 'Loading rates...') :
              React.createElement('div', { className: 'border border-white/10 rounded-xl overflow-hidden' },
                React.createElement('div', { className: 'overflow-x-auto' },
                  React.createElement('table', { className: 'w-full' },
                    React.createElement('thead', { className: 'bg-white/5 border-b border-white/10' },
                      React.createElement('tr', null,
                        React.createElement('th', { className: 'px-6 py-4 text-left text-sm font-semibold' }, 'Country'),
                        React.createElement('th', { className: 'px-6 py-4 text-left text-sm font-semibold' }, 'Currency'),
                        React.createElement('th', { className: 'px-6 py-4 text-left text-sm font-semibold' }, 'Rate (USD = 1)'),
                        React.createElement('th', { className: 'px-6 py-4 text-left text-sm font-semibold' }, 'Last Updated'),
                        React.createElement('th', { className: 'px-6 py-4 text-left text-sm font-semibold' }, 'Action')
                      )
                    ),
                    React.createElement('tbody', null,
                      rates.length === 0 ? 
                        React.createElement('tr', null,
                          React.createElement('td', { colSpan: 5, className: 'px-6 py-8 text-center text-gray-400' }, 'No rates found')
                        ) :
                        rates.map(rate =>
                          editingCountry === rate.country ?
                            React.createElement('tr', { key: rate.country, className: 'border-t border-white/5 bg-white/10' },
                              React.createElement('td', { className: 'px-6 py-4 text-sm' }, rate.country),
                              React.createElement('td', { className: 'px-6 py-4 text-sm' }, rate.currency_code),
                              React.createElement('td', { className: 'px-6 py-4 text-sm' },
                                React.createElement('input', {
                                  type: 'number',
                                  step: '0.01',
                                  value: editingRate,
                                  onChange: (e) => setEditingRate(e.target.value),
                                  className: 'w-full px-3 py-1 bg-white/10 border border-white/20 rounded text-white',
                                  autoFocus: true
                                })
                              ),
                              React.createElement('td', { className: 'px-6 py-4 text-sm text-gray-400' }, 'Editing...'),
                              React.createElement('td', { className: 'px-6 py-4 text-sm flex gap-2' },
                                React.createElement('button', {
                                  onClick: updateRate,
                                  className: 'px-3 py-1 bg-green-500/20 text-green-400 rounded hover:bg-green-500/30'
                                }, 'Save'),
                                React.createElement('button', {
                                  onClick: () => { setEditingCountry(null); setEditingRate(''); },
                                  className: 'px-3 py-1 bg-gray-500/20 text-gray-400 rounded hover:bg-gray-500/30'
                                }, 'Cancel')
                              )
                            ) :
                            React.createElement('tr', { key: rate.country, className: 'border-t border-white/5 hover:bg-white/2 transition-colors' },
                              React.createElement('td', { className: 'px-6 py-4 text-sm font-semibold' }, rate.country),
                              React.createElement('td', { className: 'px-6 py-4 text-sm' }, rate.currency_code),
                              React.createElement('td', { className: 'px-6 py-4 text-sm font-mono' }, rate.rate.toFixed(4)),
                              React.createElement('td', { className: 'px-6 py-4 text-sm text-gray-400' }, new Date(rate.updated_at).toLocaleDateString()),
                              React.createElement('td', { className: 'px-6 py-4 text-sm' },
                                React.createElement('button', {
                                  onClick: () => { setEditingCountry(rate.country); setEditingRate(rate.rate.toString()); },
                                  className: 'px-3 py-1 bg-blue-500/20 text-blue-400 rounded hover:bg-blue-500/30'
                                }, 'Edit')
                              )
                            )
                        )
                    )
                  )
                )
              )
            )
          )
        )
      );
    }

    function AppWithShortcut() {
      const [showAdmin, setShowAdmin] = useState(false);

      useEffect(() => {
        function handleKeyDown(e) {
          if (e.ctrlKey && e.shiftKey && e.key === 'A') {
            e.preventDefault();
            setShowAdmin(true);
          }
        }

        window.addEventListener('keydown', handleKeyDown);
        return () => window.removeEventListener('keydown', handleKeyDown);
      }, []);

      if (showAdmin) {
        return React.createElement(AdminDashboard);
      }

      return React.createElement('div', { className: 'hidden' });
    }

    const root = ReactDOM.createRoot(document.getElementById('app'));
    root.render(React.createElement(AppWithShortcut));
  </script>
</body>
</html>
